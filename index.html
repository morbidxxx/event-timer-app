<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Timer - Отслеживание событий</title>
    <meta name="theme-color" content="#8B5CF6">
    <meta name="description" content="Мобильное приложение для отслеживания событий с таймерами обратного отсчета">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'pulse': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        .safe-area-inset-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.3);
            border-radius: 2px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(139, 92, 246, 0.5);
        }
        
        body {
            margin: 0;
            overflow-x: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        }
        
        .backdrop-blur-lg {
            backdrop-filter: blur(16px);
        }
        
        .backdrop-blur-sm {
            backdrop-filter: blur(4px);
        }

        .backdrop-blur-light {
            backdrop-filter: blur(2px);
        }
        
        .photo-preview {
            aspect-ratio: 16/9;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .photo-preview:hover {
            transform: scale(1.02);
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script type="module">
        // Утилита для работы с локальным хранилищем
        const storage = {
            get: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch {
                    return defaultValue;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (error) {
                    console.warn('Ошибка сохранения в localStorage:', error);
                }
            }
        };

        // Класс для управления пользовательскими фотографиями
        class PhotoManager {
            constructor() {
                this.dbName = 'EventTimerPhotos';
                this.version = 1;
                this.storeName = 'userPhotos';
                this.init();
            }

            async init() {
                try {
                    this.db = await this.initDB();
                } catch (error) {
                    console.warn('Ошибка инициализации базы данных:', error);
                }
            }

            initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains(this.storeName)) {
                            const store = db.createObjectStore(this.storeName, { keyPath: 'id' });
                            store.createIndex('name', 'name', { unique: false });
                            store.createIndex('createdAt', 'createdAt', { unique: false });
                        }
                    };
                });
            }

            async savePhoto(file, customName = null) {
                if (!this.db) return null;
                
                const id = `photo_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const transaction = this.db.transaction([this.storeName], 'readwrite');
                        const store = transaction.objectStore(this.storeName);
                        
                        const photoData = {
                            id,
                            name: customName || file.name || 'Пользовательский фон',
                            blob: e.target.result,
                            size: file.size,
                            type: file.type,
                            createdAt: new Date().toISOString()
                        };

                        const request = store.add(photoData);
                        request.onsuccess = () => resolve({ id, url: e.target.result, name: photoData.name });
                        request.onerror = () => reject(request.error);
                    };
                    reader.onerror = () => reject(reader.error);
                    reader.readAsDataURL(file);
                });
            }

            async getAllPhotos() {
                if (!this.db) return [];
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.getAll();
                    
                    request.onsuccess = () => {
                        const photos = request.result.map(photo => ({
                            id: photo.id,
                            name: photo.name,
                            url: photo.blob,
                            size: photo.size,
                            createdAt: photo.createdAt
                        }));
                        resolve(photos);
                    };
                    request.onerror = () => reject(request.error);
                });
            }

            async deletePhoto(id) {
                if (!this.db) return false;
                
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([this.storeName], 'readwrite');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.delete(id);
                    
                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // Глобальный менеджер фотографий
        const photoManager = new PhotoManager();

        // Основное приложение
        class EventTimerApp {
            constructor() {
                this.events = storage.get('events', []);
                this.currentTab = 'home';
                this.showEventModal = false;
                this.showSettingsModal = false;

                this.editingEvent = null;
                this.isDark = storage.get('darkMode', true);
                this.backgroundImage = storage.get('backgroundImage', null);
                this.userPhotos = [];
                this.isFormActive = false; // Флаг активности формы
                this.activeNotifications = storage.get('activeNotifications', []);
                this.currentMonth = new Date().getMonth();
                this.currentYear = new Date().getFullYear();
                this.notificationsEnabled = storage.get('notificationsEnabled', true);
                this.staticEvents = this.generateStaticEvents();
                
                this.eventForm = {
                    title: '',
                    date: '',
                    time: '',
                    description: '',
                    color: '#8B5CF6',
                    notifications: []
                };

                this.loadUserPhotos();
                this.render();
                this.startTimer();
                this.checkNotifications();
            }

            async loadUserPhotos() {
                try {
                    this.userPhotos = await photoManager.getAllPhotos();
                    this.render();
                } catch (error) {
                    console.warn('Ошибка загрузки фотографий:', error);
                }
            }

            startTimer() {
                setInterval(() => {
                    // Если форма активна, не обновляем ничего
                    if (this.isFormActive) return;
                    
                    // Обновляем только таймеры, не всю страницу
                    this.updateTimers();
                    
                    // Проверяем уведомления каждую минуту
                    if (new Date().getSeconds() === 0) {
                        this.checkNotifications();
                    }
                }, 1000);
            }

            updateTimers() {
                // Обновляем только элементы с таймерами, избегая полного ререндера
                const timerElements = document.querySelectorAll('[data-timer-event]');
                timerElements.forEach(element => {
                    const eventId = element.getAttribute('data-timer-event');
                    const event = this.events.find(e => e.id == eventId);
                    if (event) {
                        element.innerHTML = this.renderTimerDisplayOnly(event);
                    }
                });
            }

            calculateTimeLeft(eventDate) {
                const now = new Date();
                const target = new Date(eventDate);
                const difference = target - now;

                if (difference > 0) {
                    const days = Math.floor(difference / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((difference / (1000 * 60 * 60)) % 24);
                    const minutes = Math.floor((difference / 1000 / 60) % 60);
                    const seconds = Math.floor((difference / 1000) % 60);

                    return { days, hours, minutes, seconds, expired: false };
                }

                return { days: 0, hours: 0, minutes: 0, seconds: 0, expired: true };
            }

            getUpcomingEvents() {
                const now = new Date();
                const thirtyDaysFromNow = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000));
                
                return this.getAllEvents()
                    .filter(event => {
                        const eventDate = new Date(event.dateTime);
                        const timeLeft = this.calculateTimeLeft(event.dateTime);
                        
                        // Показываем только события которые:
                        // 1. Еще не прошли
                        // 2. Произойдут в течение ближайших 30 дней
                        return !timeLeft.expired && eventDate <= thirtyDaysFromNow;
                    })
                    .sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime))
                    .slice(0, 5); // Увеличиваем до 5 для показа статичных событий
            }

            addEvent() {
                if (!this.eventForm.title || !this.eventForm.date) return;

                const newEvent = {
                    id: Date.now(),
                    ...this.eventForm,
                    dateTime: `${this.eventForm.date}T${this.eventForm.time || '12:00'}`,
                    createdAt: new Date().toISOString()
                };

                this.events.push(newEvent);
                storage.set('events', this.events);
                this.resetForm();
                this.showEventModal = false;
                this.isFormActive = false; // Деактивируем форму
                this.render();
            }



            editEvent() {
                if (!this.eventForm.title || !this.eventForm.date) return;

                const updatedEvent = {
                    ...this.editingEvent,
                    ...this.eventForm,
                    dateTime: `${this.eventForm.date}T${this.eventForm.time || '12:00'}`
                };

                this.events = this.events.map(event => 
                    event.id === this.editingEvent.id ? updatedEvent : event
                );
                
                storage.set('events', this.events);
                this.resetForm();
                this.showEventModal = false;
                this.editingEvent = null;
                this.isFormActive = false; // Деактивируем форму
                this.render();
            }

            deleteEvent(id) {
                this.events = this.events.filter(event => event.id !== id);
                storage.set('events', this.events);
                this.render();
            }

            resetForm() {
                this.eventForm = {
                    title: '',
                    date: '',
                    time: '',
                    description: '',
                    color: '#8B5CF6',
                    notifications: []
                };
            }

            setTheme(isDark) {
                this.isDark = isDark;
                storage.set('darkMode', isDark);
                this.render();
            }

            setBackgroundImage(imageUrl) {
                this.backgroundImage = imageUrl;
                storage.set('backgroundImage', imageUrl);
                this.render();
            }
            
            setBackgroundGradient(gradient) {
                this.backgroundImage = gradient;
                storage.set('backgroundImage', gradient);
                this.render();
            }

            async handlePhotoUpload(file) {
                try {
                    const result = await photoManager.savePhoto(file);
                    if (result) {
                        await this.loadUserPhotos();
                        this.setBackgroundImage(result.url);
                    }
                } catch (error) {
                    console.error('Ошибка загрузки фотографии:', error);
                    alert('Ошибка при загрузке фотографии');
                }
            }

            async deletePhoto(photoId) {
                try {
                    await photoManager.deletePhoto(photoId);
                    
                    // Если удаляемое фото было фоном, сбросить фон
                    const deletedPhoto = this.userPhotos.find(p => p.id === photoId);
                    if (deletedPhoto && this.backgroundImage === deletedPhoto.url) {
                        this.setBackgroundImage(null);
                    }
                    
                    await this.loadUserPhotos();
                } catch (error) {
                    console.error('Ошибка удаления фотографии:', error);
                }
            }

            // Генерация статичных событий
            generateStaticEvents() {
                const currentYear = new Date().getFullYear();
                const staticEvents = [];
                
                // Генерируем события на текущий и следующий год
                for (let year = currentYear; year <= currentYear + 1; year++) {
                    for (let month = 0; month < 12; month++) {
                        // Аванс 15 числа
                        const advanceDate = new Date(year, month, 15, 9, 0); // 09:00
                        staticEvents.push({
                            id: `advance-${year}-${month}`,
                            title: 'Зарплатка 💰',
                            dateTime: advanceDate.toISOString(),
                            description: 'Выплата заработной платы',
                            color: '#10B981', // Зеленый
                            isStatic: true,
                            type: 'advance'
                        });

                        // ЗП 30 числа (или последний день месяца)
                        const lastDay = new Date(year, month + 1, 0).getDate();
                        const salaryDay = Math.min(30, lastDay);
                        const salaryDate = new Date(year, month, salaryDay, 17, 0); // 17:00
                        staticEvents.push({
                            id: `salary-${year}-${month}`,
                            title: 'АВАНС 💸',
                            dateTime: salaryDate.toISOString(),
                            description: 'Аанс по заработной плате',
                            color: '#F59E0B', // Оранжевый
                            isStatic: true,
                            type: 'salary'
                        });
                    }
                }
                
                return staticEvents;
            }

            // Получить все события (пользовательские + статичные)
            getAllEvents() {
                const now = new Date();
                const futureStaticEvents = this.staticEvents.filter(event => 
                    new Date(event.dateTime) > now
                );
                return [...this.events, ...futureStaticEvents];
            }

            // Функции для работы с уведомлениями
            toggleNotifications() {
                this.notificationsEnabled = !this.notificationsEnabled;
                storage.set('notificationsEnabled', this.notificationsEnabled);
                
                if (!this.notificationsEnabled) {
                    // Очищаем активные уведомления при отключении
                    this.activeNotifications = [];
                    storage.set('activeNotifications', []);
                }
                this.render();
            }

            checkNotifications() {
                if (!this.notificationsEnabled) return;
                const now = new Date();
                const newNotifications = [];
                
                // Проверяем как пользовательские, так и статичные события
                const allEvents = this.getAllEvents();

                allEvents.forEach(event => {
                    const eventDate = new Date(event.dateTime);
                    const timeDiff = eventDate - now;
                    const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

                    // Проверяем уведомления за 3 дня
                    if (daysDiff === 3) {
                        const notificationId = `${event.id}-3days`;
                        if (!this.activeNotifications.find(n => n.id === notificationId)) {
                            newNotifications.push({
                                id: notificationId,
                                eventId: event.id,
                                eventTitle: event.title,
                                type: '3days',
                                message: `До события "${event.title}" осталось 3 дня`,
                                createdAt: new Date().toISOString(),
                                read: false
                            });
                        }
                    }

                    // Проверяем уведомления за 1 день
                    if (daysDiff === 1) {
                        const notificationId = `${event.id}-1day`;
                        if (!this.activeNotifications.find(n => n.id === notificationId)) {
                            newNotifications.push({
                                id: notificationId,
                                eventId: event.id,
                                eventTitle: event.title,
                                type: '1day',
                                message: `До события "${event.title}" осталось 1 день`,
                                createdAt: new Date().toISOString(),
                                read: false
                            });
                        }
                    }

                    // Проверяем уведомления в день события
                    if (daysDiff === 0 && timeDiff > 0) {
                        const notificationId = `${event.id}-today`;
                        if (!this.activeNotifications.find(n => n.id === notificationId)) {
                            newNotifications.push({
                                id: notificationId,
                                eventId: event.id,
                                eventTitle: event.title,
                                type: 'today',
                                message: `Сегодня: "${event.title}"`,
                                createdAt: new Date().toISOString(),
                                read: false
                            });
                        }
                    }
                });

                if (newNotifications.length > 0) {
                    this.activeNotifications = [...this.activeNotifications, ...newNotifications];
                    storage.set('activeNotifications', this.activeNotifications);
                    
                    // Показываем браузерное уведомление если разрешено
                    if (Notification.permission === 'granted') {
                        newNotifications.forEach(notification => {
                            new Notification('Event Timer', {
                                body: notification.message,
                                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%238B5CF6" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>'
                            });
                        });
                    }
                }
            }

            markNotificationAsRead(notificationId) {
                this.activeNotifications = this.activeNotifications.map(notification =>
                    notification.id === notificationId ? { ...notification, read: true } : notification
                );
                storage.set('activeNotifications', this.activeNotifications);
                this.render();
            }

            deleteNotification(notificationId) {
                this.activeNotifications = this.activeNotifications.filter(n => n.id !== notificationId);
                storage.set('activeNotifications', this.activeNotifications);
                this.render();
            }

            getUnreadNotificationsCount() {
                try {
                    return this.activeNotifications ? this.activeNotifications.filter(n => !n.read).length : 0;
                } catch (error) {
                    console.error('Ошибка подсчета уведомлений:', error);
                    return 0;
                }
            }

            requestNotificationPermission() {
                if ('Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        console.log('Разрешение на уведомления:', permission);
                        if (permission === 'granted') {
                            // Показываем тестовое уведомление
                            setTimeout(() => {
                                try {
                                    new Notification('Event Timer ✅', {
                                        body: 'Уведомления успешно включены! Теперь вы будете получать напоминания о событиях.',
                                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40NzcgMiAyIDYuNDc3IDIgMTJzNC40NzcgMTAgMTAgMTAgMTAtNC40NzcgMTAtMTBTMTcuNTIzIDIgMTIgMnoiIGZpbGw9IiM4QjVDRjYiLz4KPHBhdGggZD0iTTkgMTJsMS41IDEuNUwxNSA5IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KPC9zdmc+',
                                        tag: 'event-timer-test',
                                        requireInteraction: false
                                    });
                                } catch (error) {
                                    console.log('Тестовое уведомление не удалось показать:', error);
                                }
                            }, 500);
                        }
                        this.render();
                    }).catch(error => {
                        console.error('Ошибка при запросе разрешений:', error);
                        this.render();
                    });
                } else {
                    console.log('Браузер не поддерживает уведомления');
                }
            }

            // Функции для календаря
            getDaysInMonth(year, month) {
                return new Date(year, month + 1, 0).getDate();
            }

            getFirstDayOfMonth(year, month) {
                return new Date(year, month, 1).getDay();
            }

            getEventsForDate(date) {
                const dateStr = date.toISOString().split('T')[0];
                return this.getAllEvents().filter(event => event.dateTime.split('T')[0] === dateStr);
            }

            changeMonth(direction) {
                if (direction === 'prev') {
                    if (this.currentMonth === 0) {
                        this.currentMonth = 11;
                        this.currentYear--;
                    } else {
                        this.currentMonth--;
                    }
                } else {
                    if (this.currentMonth === 11) {
                        this.currentMonth = 0;
                        this.currentYear++;
                    } else {
                        this.currentMonth++;
                    }
                }
                this.render();
            }

            renderTimerDisplay(event) {
                return `<div data-timer-event="${event.id}">${this.renderTimerDisplayOnly(event)}</div>`;
            }

            renderTimerDisplayOnly(event) {
                const timeLeft = this.calculateTimeLeft(event.dateTime);
                
                if (timeLeft.expired) {
                    return `<div class="text-red-400 font-semibold">Событие прошло</div>`;
                }

                return `
                    <div class="grid grid-cols-4 gap-2 text-center">
                        <div class="bg-white/10 rounded-lg p-2">
                            <div class="text-lg font-bold">${timeLeft.days}</div>
                            <div class="text-xs opacity-70">дней</div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-2">
                            <div class="text-lg font-bold">${timeLeft.hours}</div>
                            <div class="text-xs opacity-70">часов</div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-2">
                            <div class="text-lg font-bold">${timeLeft.minutes}</div>
                            <div class="text-xs opacity-70">мин</div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-2">
                            <div class="text-lg font-bold animate-pulse">${timeLeft.seconds}</div>
                            <div class="text-xs opacity-70">сек</div>
                        </div>
                    </div>
                `;
            }

            render() {
                const bgClasses = this.isDark 
                    ? 'bg-gradient-to-br from-gray-900 via-purple-900 to-violet-900' 
                    : 'bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50';
                
                const cardClasses = this.isDark 
                    ? 'bg-gradient-to-br from-purple-800/20 via-pink-800/20 to-gray-800/20 border-purple-500/30' 
                    : 'bg-gradient-to-br from-white/80 via-purple-50/80 to-pink-50/80 border-purple-200';

                const textClasses = this.isDark ? 'text-white' : 'text-gray-900';

                const backgroundStyle = this.backgroundImage 
                    ? (this.backgroundImage.startsWith('linear-gradient') 
                        ? `background: ${this.backgroundImage};`
                        : `background-image: url('${this.backgroundImage}'); background-size: cover; background-position: center; background-attachment: fixed;`)
                    : '';

                const upcomingEvents = this.getUpcomingEvents();

                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen ${bgClasses} ${textClasses} relative overflow-hidden" style="${backgroundStyle}">
                        ${this.backgroundImage ? `<div class="absolute inset-0 ${this.isDark ? 'bg-black/30' : 'bg-white/20'} backdrop-blur-light"></div>` : ''}
                        
                        <div class="relative z-10 flex flex-col h-screen">
                            <!-- Заголовок -->
                            <div class="flex items-center justify-between p-4 border-b border-purple-500/30">
                                <div class="flex items-center gap-3">
                                    <i data-lucide="clock" class="w-8 h-8 text-purple-400"></i>
                                    <h1 class="text-xl font-bold bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                                        Event Timer
                                    </h1>
                                </div>
                                
                                <div class="flex items-center gap-2">
                                    <button onclick="app.setTheme(!app.isDark)" class="p-2 rounded-full bg-purple-500/20 text-purple-300 hover:bg-purple-500/30 transition-colors">
                                        <i data-lucide="palette" class="w-5 h-5"></i>
                                    </button>
                                    <button onclick="app.currentTab = 'photos'; app.render();" class="p-2 rounded-full bg-purple-500/20 text-purple-300 hover:bg-purple-500/30 transition-colors">
                                        <i data-lucide="image" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Основной контент -->
                            <div class="flex-1 overflow-hidden">
                                ${this.renderCurrentTab(cardClasses, upcomingEvents)}
                            </div>

                            <!-- Нижняя навигация -->
                            <div class="border-t border-purple-500/30 ${cardClasses} backdrop-blur-lg safe-area-inset-bottom">
                                <div class="flex items-center justify-around py-3">
                                    ${[
                                        { id: 'home', icon: 'home', label: 'Главная' },
                                        { id: 'events', icon: 'list', label: 'События' },
                                        { id: 'notifications', icon: 'bell', label: 'Уведомления' },
                                        { id: 'calendar', icon: 'calendar', label: 'Календарь' },
                                        { id: 'photos', icon: 'image', label: 'Фото' }
                                    ].map(tab => `
                                        <button onclick="app.currentTab = '${tab.id}'; app.render();" class="flex flex-col items-center gap-1 p-2 rounded-lg transition-all duration-300 relative ${this.currentTab === tab.id ? 'text-purple-400 bg-purple-500/20' : 'text-gray-400 hover:text-purple-300'}">
                                            <i data-lucide="${tab.icon}" class="w-5 h-5"></i>
                                            <span class="text-xs font-medium">${tab.label}</span>
                                            ${tab.id === 'notifications' && this.getUnreadNotificationsCount() > 0 ? `
                                                <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center font-bold animate-pulse">
                                                    ${this.getUnreadNotificationsCount()}
                                                </span>
                                            ` : ''}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>

                            ${this.renderModals(cardClasses)}
                            
                            <!-- Плавающая кнопка добавления -->
                            ${this.currentTab !== 'events' && this.currentTab !== 'photos' ? `
                                <button onclick="app.openNewEventModal();" class="fixed bottom-20 right-4 w-14 h-14 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center text-white shadow-lg hover:shadow-xl transform hover:scale-110 transition-all duration-300 z-40">
                                    <i data-lucide="plus" class="w-6 h-6"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;

                // Инициализируем иконки Lucide
                lucide.createIcons();
            }

            renderCurrentTab(cardClasses, upcomingEvents) {
                switch (this.currentTab) {
                    case 'home':
                        return `
                            <div class="p-4 space-y-6 overflow-y-auto h-full pb-20">
                                <div class="p-6 rounded-2xl border ${cardClasses} backdrop-blur-lg">
                                    <h2 class="text-2xl font-bold mb-2">Morbidx!, 👋</h2>
                                    <p class="opacity-80">У вас ${this.events.length} событий, ${upcomingEvents.length} предстоящих</p>
                                </div>

                                ${upcomingEvents.length > 0 ? `
                                    <div class="space-y-4">
                                        <h3 class="text-lg font-semibold flex items-center gap-2">
                                            <i data-lucide="clock" class="w-5 h-5 text-purple-400"></i>
                                            Ближайшие события
                                        </h3>
                                        
                                        ${upcomingEvents.map(event => `
                                            <div class="p-4 rounded-xl border ${cardClasses} backdrop-blur-lg ${event.isStatic ? 'ring-2 ring-purple-400/50' : ''}" ${event.color ? `style="border-color: ${event.color}40;"` : ''}>
                                                <div class="flex items-start justify-between mb-3">
                                                    <div>
                                                        <div class="flex items-center gap-2">
                                                            <h4 class="font-semibold text-lg">${event.title}</h4>
                                                            ${event.isStatic ? '<span class="px-2 py-1 text-xs bg-purple-500/20 text-purple-300 rounded-full">Регулярно</span>' : ''}
                                                        </div>
                                                        <p class="text-sm opacity-70">
                                                            ${new Date(event.dateTime).toLocaleDateString('ru-RU', {
                                                                day: 'numeric',
                                                                month: 'long',
                                                                year: 'numeric',
                                                                hour: '2-digit',
                                                                minute: '2-digit'
                                                            })}
                                                        </p>
                                                        ${event.description ? `<p class="text-sm opacity-60 mt-1">${event.description}</p>` : ''}
                                                    </div>
                                                    ${event.color && event.color !== '#8B5CF6' ? `
                                                        <div class="w-4 h-4 rounded-full border-2 border-white/30" style="background-color: ${event.color};"></div>
                                                    ` : ''}
                                                </div>
                                                
                                                ${this.renderTimerDisplay(event)}
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="p-6 rounded-2xl border ${cardClasses} backdrop-blur-lg text-center">
                                        <i data-lucide="calendar" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                                        <h3 class="text-xl font-semibold mb-2">Нет предстоящих событий</h3>
                                        <p class="opacity-70 mb-4">Добавьте свое первое событие!</p>
                                        <button onclick="app.openNewEventModal();" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-purple-600 hover:to-pink-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                                            Добавить событие
                                        </button>
                                    </div>
                                `}
                            </div>
                        `;

                    case 'events':
                        return `
                            <div class="p-4 space-y-4 overflow-y-auto h-full pb-20">
                                <div class="flex items-center justify-between">
                                    <h2 class="text-xl font-bold flex items-center gap-2">
                                        <i data-lucide="list" class="w-6 h-6 text-purple-400"></i>
                                        Все события (${this.events.length})
                                    </h2>
                                    <button onclick="app.openNewEventModal();" class="p-2 rounded-full bg-purple-500 text-white hover:bg-purple-600 transition-colors">
                                        <i data-lucide="plus" class="w-5 h-5"></i>
                                    </button>
                                </div>

                                ${this.events.length > 0 ? `
                                    <div class="space-y-3">
                                        ${this.events
                                            .sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime))
                                            .map(event => `
                                                <div class="p-4 rounded-xl border ${cardClasses} backdrop-blur-lg">
                                                    <div class="flex items-start justify-between mb-3">
                                                        <div class="flex-1">
                                                            <h4 class="font-semibold text-lg">${event.title}</h4>
                                                            <p class="text-sm opacity-70">
                                                                ${new Date(event.dateTime).toLocaleDateString('ru-RU', {
                                                                    day: 'numeric',
                                                                    month: 'long',
                                                                    year: 'numeric',
                                                                    hour: '2-digit',
                                                                    minute: '2-digit'
                                                                })}
                                                            </p>
                                                            ${event.description ? `<p class="text-sm opacity-80 mt-1">${event.description}</p>` : ''}
                                                        </div>
                                                        
                                                        <div class="flex items-center gap-2">
                                                            <button onclick="app.startEditEvent('${event.id}')" class="p-2 rounded-lg bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 transition-colors">
                                                                <i data-lucide="edit" class="w-4 h-4"></i>
                                                            </button>
                                                            <button onclick="app.deleteEvent('${event.id}')" class="p-2 rounded-lg bg-red-500/20 text-red-300 hover:bg-red-500/30 transition-colors">
                                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    ${this.renderTimerDisplay(event)}
                                                </div>
                                            `).join('')}
                                    </div>
                                ` : `
                                    <div class="p-6 rounded-2xl border ${cardClasses} backdrop-blur-lg text-center">
                                        <i data-lucide="list" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                                        <h3 class="text-xl font-semibold mb-2">Нет событий</h3>
                                        <p class="opacity-70">Создайте свое первое событие!</p>
                                    </div>
                                `}
                            </div>
                        `;

                    case 'photos':
                        return `
                            <div class="p-4 space-y-4 overflow-y-auto h-full pb-20">
                                <div class="flex items-center justify-between">
                                    <h2 class="text-xl font-bold flex items-center gap-2">
                                        <i data-lucide="image" class="w-6 h-6 text-purple-400"></i>
                                        Мои фото (${this.userPhotos.length})
                                    </h2>
                                    <label class="p-2 rounded-full bg-purple-500 text-white hover:bg-purple-600 transition-colors cursor-pointer">
                                        <i data-lucide="plus" class="w-5 h-5"></i>
                                        <input type="file" accept="image/*" class="hidden" onchange="app.handleFileUpload(event)">
                                    </label>
                                </div>

                                <!-- Предустановленные градиенты -->
                                <div class="space-y-3">
                                    <h3 class="text-lg font-semibold">Готовые фоны</h3>
                                    <div class="photo-grid">
                                        ${[
                                            { id: 'gradient1', name: 'Фиолетовый градиент', style: 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);', value: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                                            { id: 'gradient2', name: 'Розовый закат', style: 'background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);', value: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
                                            { id: 'gradient3', name: 'Океан', style: 'background: linear-gradient(135deg, #667db6 0%, #0082c8 100%);', value: 'linear-gradient(135deg, #667db6 0%, #0082c8 100%)' },
                                            { id: 'gradient4', name: 'Лес', style: 'background: linear-gradient(135deg, #74b9ff 0%, #55a3ff 100%);', value: 'linear-gradient(135deg, #74b9ff 0%, #55a3ff 100%)' },
                                            { id: 'none', name: 'Без фона', style: 'background: #374151; border: 2px dashed #9CA3AF;', value: null }
                                        ].map(bg => `
                                            <div class="relative">
                                                <div onclick="app.setBackgroundImage(${bg.value ? `'${bg.value}'` : 'null'})" 
                                                     class="photo-preview rounded-lg border-2 ${this.backgroundImage === bg.value ? 'border-purple-400' : 'border-gray-300'} flex items-center justify-center text-sm font-medium cursor-pointer hover:border-purple-300 transition-colors" 
                                                     style="${bg.style} height: 80px;">
                                                    ${bg.id === 'none' ? 'Без фона' : bg.name}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <!-- Пользовательские фото -->
                                ${this.userPhotos.length > 0 ? `
                                    <div class="space-y-3">
                                        <h3 class="text-lg font-semibold">Ваши фото</h3>
                                        <div class="photo-grid">
                                            ${this.userPhotos.map(photo => `
                                                <div class="relative group">
                                                    <img src="${photo.url}" 
                                                         alt="${photo.name}" 
                                                         class="photo-preview rounded-lg border-2 ${this.backgroundImage === photo.url ? 'border-purple-400' : 'border-gray-300'}"
                                                         onclick="app.setBackgroundImage('${photo.url}')">
                                                    
                                                    <button onclick="app.deletePhoto('${photo.id}')" 
                                                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <i data-lucide="x" class="w-3 h-3"></i>
                                                    </button>
                                                    
                                                    <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs p-1 rounded-b-lg truncate opacity-0 group-hover:opacity-100 transition-opacity">
                                                        ${photo.name}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : `
                                    <div class="p-6 rounded-2xl border ${cardClasses} backdrop-blur-lg text-center">
                                        <i data-lucide="image" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                                        <h3 class="text-xl font-semibold mb-2">Нет загруженных фото</h3>
                                        <p class="opacity-70 mb-4">Добавьте свои фотографии для фона</p>
                                        <label class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-xl font-semibold hover:from-purple-600 hover:to-pink-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 cursor-pointer inline-block">
                                            Загрузить фото
                                            <input type="file" accept="image/*" class="hidden" onchange="app.handleFileUpload(event)">
                                        </label>
                                    </div>
                                `}
                            </div>
                        `;

                    case 'notifications':
                        return `
                            <div class="p-4 space-y-4 overflow-y-auto h-full pb-20">
                                <div class="flex items-center justify-between">
                                    <h2 class="text-xl font-bold flex items-center gap-2">
                                        <i data-lucide="bell" class="w-6 h-6 text-purple-400"></i>
                                        Уведомления ${this.getUnreadNotificationsCount() > 0 ? `(${this.getUnreadNotificationsCount()})` : ''}
                                    </h2>
                                </div>

                                <div class="space-y-4">
                                    ${!('Notification' in window) ? `
                                        <div class="p-4 rounded-xl bg-orange-500/20 border border-orange-400/30 ${cardClasses}">
                                            <div class="flex items-start gap-3">
                                                <i data-lucide="alert-triangle" class="w-5 h-5 text-orange-400 mt-0.5"></i>
                                                <div>
                                                    <h4 class="font-semibold text-orange-300">Уведомления недоступны</h4>
                                                    <p class="text-sm opacity-80 mt-1">Ваш браузер не поддерживает push-уведомления</p>
                                                </div>
                                            </div>
                                        </div>
                                    ` : Notification.permission === 'default' ? `
                                        <div class="p-4 rounded-xl bg-blue-500/20 border border-blue-400/30 ${cardClasses}">
                                            <div class="flex items-start gap-3">
                                                <i data-lucide="info" class="w-5 h-5 text-blue-400 mt-0.5"></i>
                                                <div>
                                                    <h4 class="font-semibold text-blue-300">Разрешите уведомления</h4>
                                                    <p class="text-sm opacity-80 mt-1">Чтобы получать уведомления о предстоящих событиях, нажмите "Разрешить"</p>
                                                    <div class="flex gap-2 mt-3">
                                                        <button onclick="app.requestNotificationPermission()" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 transition-colors">
                                                            Разрешить уведомления
                                                        </button>
                                                        <button onclick="app.testNotification()" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 transition-colors">
                                                            Тест
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ` : Notification.permission === 'granted' ? `
                                        <div class="p-4 rounded-xl bg-green-500/20 border border-green-400/30 ${cardClasses}">
                                            <div class="flex items-start gap-3">
                                                <i data-lucide="check-circle" class="w-5 h-5 text-green-400 mt-0.5"></i>
                                                <div class="flex-1">
                                                    <h4 class="font-semibold text-green-300">Уведомления разрешены ✅</h4>
                                                    <p class="text-sm opacity-80 mt-1">Вы будете получать уведомления о предстоящих событиях</p>
                                                </div>
                                                <button onclick="app.testNotification()" class="px-3 py-1 bg-green-600 text-white rounded-lg text-sm hover:bg-green-700 transition-colors">
                                                    Тест
                                                </button>
                                            </div>
                                        </div>
                                    ` : Notification.permission === 'denied' ? `
                                        <div class="p-4 rounded-xl bg-red-500/20 border border-red-400/30 ${cardClasses}">
                                            <div class="flex items-start gap-3">
                                                <i data-lucide="alert-triangle" class="w-5 h-5 text-red-400 mt-0.5"></i>
                                                <div>
                                                    <h4 class="font-semibold text-red-300">Уведомления заблокированы</h4>
                                                    <p class="text-sm opacity-80 mt-1">Разрешите уведомления в настройках браузера для получения напоминаний</p>
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}

                                    <!-- Настройки уведомлений -->
                                    <div class="p-4 rounded-xl border ${cardClasses} backdrop-blur-lg">
                                        <h4 class="font-semibold mb-3 flex items-center gap-2">
                                            <i data-lucide="settings" class="w-5 h-5 text-purple-400"></i>
                                            Настройки уведомлений
                                        </h4>
                                        
                                        <div class="flex items-center justify-between mb-4 p-3 rounded-lg ${this.isDark ? 'bg-gray-800/50' : 'bg-purple-50/50'}">
                                            <span class="text-sm font-medium">Включить уведомления</span>
                                            <button onclick="app.toggleNotifications()" class="relative inline-flex items-center w-11 h-6 rounded-full transition-colors ${this.notificationsEnabled ? 'bg-purple-500' : 'bg-gray-400'}">
                                                <span class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform ${this.notificationsEnabled ? 'translate-x-6' : 'translate-x-1'}"></span>
                                            </button>
                                        </div>

                                        <div class="space-y-2 text-sm ${this.notificationsEnabled ? 'opacity-80' : 'opacity-40'}">
                                            <div class="flex items-center gap-2">
                                                <i data-lucide="${this.notificationsEnabled ? 'check-circle' : 'x-circle'}" class="w-4 h-4 ${this.notificationsEnabled ? 'text-green-400' : 'text-gray-400'}"></i>
                                                <span>За 3 дня до события</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <i data-lucide="${this.notificationsEnabled ? 'check-circle' : 'x-circle'}" class="w-4 h-4 ${this.notificationsEnabled ? 'text-green-400' : 'text-gray-400'}"></i>
                                                <span>За 1 день до события</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <i data-lucide="${this.notificationsEnabled ? 'check-circle' : 'x-circle'}" class="w-4 h-4 ${this.notificationsEnabled ? 'text-green-400' : 'text-gray-400'}"></i>
                                                <span>В день события</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Список уведомлений -->
                                    ${this.activeNotifications.length === 0 ? `
                                        <div class="p-6 rounded-2xl border ${cardClasses} backdrop-blur-lg text-center">
                                            <i data-lucide="bell-off" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                                            <h3 class="text-xl font-semibold mb-2">Нет уведомлений</h3>
                                            <p class="opacity-70">${this.notificationsEnabled ? 'Уведомления появятся за 3 дня и 1 день до ваших событий' : 'Уведомления отключены в настройках'}</p>
                                        </div>
                                    ` : `
                                        <div class="space-y-3">
                                            <h3 class="text-lg font-semibold flex items-center gap-2">
                                                <i data-lucide="inbox" class="w-5 h-5 text-purple-400"></i>
                                                Активные уведомления (${this.activeNotifications.length})
                                            </h3>
                                            
                                            ${this.activeNotifications
                                                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                                                .map(notification => `
                                                    <div class="p-4 rounded-xl border ${notification.read ? 'bg-gray-500/10 border-gray-500/30' : 'bg-purple-500/20 border-purple-400/30'} ${cardClasses} transition-all">
                                                        <div class="flex items-start gap-3">
                                                            <div class="flex-1">
                                                                <div class="flex items-center gap-2 mb-2">
                                                                    ${notification.type === '3days' ? `<i data-lucide="calendar" class="w-4 h-4 text-orange-400"></i>` : 
                                                                      notification.type === '1day' ? `<i data-lucide="clock" class="w-4 h-4 text-yellow-400"></i>` :
                                                                      `<i data-lucide="bell-ring" class="w-4 h-4 text-red-400"></i>`}
                                                                    <span class="text-sm font-semibold ${notification.read ? 'opacity-70' : ''}">${notification.eventTitle}</span>
                                                                    ${!notification.read ? `<div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div>` : ''}
                                                                </div>
                                                                <p class="text-sm ${notification.read ? 'opacity-50' : 'opacity-80'} mb-2">${notification.message}</p>
                                                                <p class="text-xs opacity-50">
                                                                    ${new Date(notification.createdAt).toLocaleDateString('ru-RU', {
                                                                        day: 'numeric',
                                                                        month: 'short',
                                                                        hour: '2-digit',
                                                                        minute: '2-digit'
                                                                    })}
                                                                </p>
                                                            </div>
                                                            <div class="flex gap-2">
                                                                ${!notification.read ? `
                                                                    <button onclick="app.markNotificationAsRead('${notification.id}')" class="p-2 rounded-lg bg-green-500/20 text-green-300 hover:bg-green-500/30 transition-colors" title="Отметить как прочитанное">
                                                                        <i data-lucide="check" class="w-4 h-4"></i>
                                                                    </button>
                                                                ` : ''}
                                                                <button onclick="app.deleteNotification('${notification.id}')" class="p-2 rounded-lg bg-red-500/20 text-red-300 hover:bg-red-500/30 transition-colors" title="Удалить уведомление">
                                                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                        </div>
                                    `}
                                </div>
                            </div>
                        `;

                    case 'calendar':
                        const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                            'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
                        const dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
                        const daysInMonth = this.getDaysInMonth(this.currentYear, this.currentMonth);
                        const firstDay = this.getFirstDayOfMonth(this.currentYear, this.currentMonth);
                        
                        let calendarDays = [];
                        
                        // Пустые ячейки для начала месяца
                        for (let i = 0; i < firstDay; i++) {
                            calendarDays.push('');
                        }
                        
                        // Дни месяца
                        for (let day = 1; day <= daysInMonth; day++) {
                            const date = new Date(this.currentYear, this.currentMonth, day);
                            const events = this.getEventsForDate(date);
                            calendarDays.push({ day, date, events });
                        }

                        return `
                            <div class="p-4 space-y-4 overflow-y-auto h-full pb-20">
                                <div class="flex items-center justify-between">
                                    <h2 class="text-xl font-bold flex items-center gap-2">
                                        <i data-lucide="calendar" class="w-6 h-6 text-purple-400"></i>
                                        Календарь событий
                                    </h2>
                                </div>

                                <div class="p-4 rounded-2xl border ${cardClasses} backdrop-blur-lg">
                                    <!-- Заголовок календаря -->
                                    <div class="flex items-center justify-between mb-4">
                                        <button onclick="app.changeMonth('prev')" class="p-2 rounded-lg bg-purple-500/20 text-purple-300 hover:bg-purple-500/30 transition-colors">
                                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                                        </button>
                                        <h3 class="text-lg font-semibold">
                                            ${monthNames[this.currentMonth]} ${this.currentYear}
                                        </h3>
                                        <button onclick="app.changeMonth('next')" class="p-2 rounded-lg bg-purple-500/20 text-purple-300 hover:bg-purple-500/30 transition-colors">
                                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                                        </button>
                                    </div>

                                    <!-- Дни недели -->
                                    <div class="grid grid-cols-7 gap-1 mb-2">
                                        ${dayNames.map(day => `
                                            <div class="text-center text-sm font-medium p-2 opacity-70">
                                                ${day}
                                            </div>
                                        `).join('')}
                                    </div>

                                    <!-- Календарная сетка -->
                                    <div class="grid grid-cols-7 gap-1">
                                        ${calendarDays.map(dayData => {
                                            if (!dayData) {
                                                return '<div class="aspect-square"></div>';
                                            }
                                            
                                            const { day, date, events } = dayData;
                                            const isToday = date.toDateString() === new Date().toDateString();
                                            const hasEvents = events.length > 0;
                                            
                                            return `
                                                <div class="aspect-square p-1">
                                                    <div class="w-full h-full rounded-lg border transition-all ${
                                                        isToday ? 'bg-purple-500 text-white border-purple-400' : 
                                                        hasEvents ? 'bg-purple-500/20 border-purple-400/50 text-purple-300' :
                                                        'border-gray-600/30 hover:border-purple-400/30'
                                                    } flex flex-col items-center justify-center text-sm relative">
                                                        <span class="font-medium">${day}</span>
                                                        ${hasEvents ? `
                                                            <div class="flex gap-1 mt-1">
                                                                ${events.slice(0, 3).map(() => `
                                                                    <div class="w-1 h-1 rounded-full bg-current opacity-80"></div>
                                                                `).join('')}
                                                                ${events.length > 3 ? `<div class="text-xs">+</div>` : ''}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>

                                <!-- События выбранного дня -->
                                ${(() => {
                                    const today = new Date();
                                    const todayEvents = this.getEventsForDate(today);
                                    
                                    if (todayEvents.length > 0) {
                                        return `
                                            <div class="space-y-3">
                                                <h3 class="text-lg font-semibold">События на сегодня</h3>
                                                ${todayEvents.map(event => `
                                                    <div class="p-3 rounded-xl border ${cardClasses} backdrop-blur-lg">
                                                        <div class="flex items-center justify-between">
                                                            <div>
                                                                <h4 class="font-semibold">${event.title}</h4>
                                                                <p class="text-sm opacity-70">
                                                                    ${new Date(event.dateTime).toLocaleTimeString('ru-RU', {
                                                                        hour: '2-digit',
                                                                        minute: '2-digit'
                                                                    })}
                                                                </p>
                                                            </div>
                                                            <button onclick="app.startEditEvent('${event.id}')" class="p-2 rounded-lg bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 transition-colors">
                                                                <i data-lucide="edit" class="w-4 h-4"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `;
                                    }
                                    return '';
                                })()}
                            </div>
                        `;

                    default:
                        return `
                            <div class="p-4 flex items-center justify-center h-full">
                                <div class="p-6 rounded-2xl border ${cardClasses} backdrop-blur-lg text-center">
                                    <h3 class="text-xl font-semibold mb-2">Скоро будет!</h3>
                                    <p class="opacity-70">Эта вкладка находится в разработке</p>
                                </div>
                            </div>
                        `;
                }
            }

            renderModals(cardClasses) {
                let modals = '';

                // Модальное окно события
                if (this.showEventModal) {
                    modals += `
                        <div class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div class="w-full max-w-md p-6 rounded-2xl border ${cardClasses} backdrop-blur-lg modal-form">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-xl font-bold">
                                        ${this.editingEvent ? 'Редактировать событие' : 'Новое событие'}
                                    </h3>
                                    <button onclick="app.closeEventModal()" class="p-2 rounded-full hover:bg-purple-500/20 transition-colors">
                                        <i data-lucide="x" class="w-5 h-5"></i>
                                    </button>
                                </div>

                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Название события</label>
                                        <input type="text" id="eventTitle" value="${this.eventForm.title}" placeholder="Введите название..." 
                                               onfocus="app.isFormActive = true"
                                               onblur="setTimeout(() => app.isFormActive = false, 100)"
                                               onchange="app.updateEventForm('title', this.value)" 
                                               oninput="app.updateEventForm('title', this.value)"
                                               class="w-full p-3 rounded-xl border ${this.isDark ? 'bg-gray-800/50 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-900'} focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    </div>

                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-2">Дата</label>
                                            <input type="date" id="eventDate" value="${this.eventForm.date}"
                                                   onfocus="app.isFormActive = true"
                                                   onblur="setTimeout(() => app.isFormActive = false, 100)"
                                                   onchange="app.updateEventForm('date', this.value)"
                                                   class="w-full p-3 rounded-xl border ${this.isDark ? 'bg-gray-800/50 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-900'} focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        </div>

                                        <div>
                                            <label class="block text-sm font-medium mb-2">Время</label>
                                            <input type="time" id="eventTime" value="${this.eventForm.time}"
                                                   onfocus="app.isFormActive = true"
                                                   onblur="setTimeout(() => app.isFormActive = false, 100)"
                                                   onchange="app.updateEventForm('time', this.value)"
                                                   class="w-full p-3 rounded-xl border ${this.isDark ? 'bg-gray-800/50 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-900'} focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium mb-2">Описание (необязательно)</label>
                                        <textarea id="eventDescription" placeholder="Добавьте описание..." rows="3" 
                                                  onfocus="app.isFormActive = true"
                                                  onblur="setTimeout(() => app.isFormActive = false, 100)"
                                                  onchange="app.updateEventForm('description', this.value)"
                                                  oninput="app.updateEventForm('description', this.value)"
                                                  class="w-full p-3 rounded-xl border ${this.isDark ? 'bg-gray-800/50 border-gray-600 text-white' : 'bg-white border-gray-300 text-gray-900'} focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none">${this.eventForm.description}</textarea>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium mb-2">Цвет события</label>
                                        <div class="flex gap-2 flex-wrap">
                                            ${[
                                                { color: '#8B5CF6', name: 'Фиолетовый' },
                                                { color: '#EF4444', name: 'Красный' },
                                                { color: '#F59E0B', name: 'Оранжевый' },
                                                { color: '#10B981', name: 'Зеленый' },
                                                { color: '#3B82F6', name: 'Синий' },
                                                { color: '#EC4899', name: 'Розовый' },
                                                { color: '#6366F1', name: 'Индиго' },
                                                { color: '#8B5A3C', name: 'Коричневый' }
                                            ].map(colorOption => `
                                                <button type="button" onclick="app.updateEventForm('color', '${colorOption.color}')" 
                                                        class="w-8 h-8 rounded-full border-2 transition-all hover:scale-110 ${this.eventForm.color === colorOption.color ? 'border-white ring-2 ring-white/50' : 'border-gray-400'}"
                                                        style="background-color: ${colorOption.color};"
                                                        title="${colorOption.name}">
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <div class="flex gap-3 pt-4">
                                        <button onclick="app.closeEventModal()" class="flex-1 py-3 px-4 rounded-xl border border-gray-500 text-gray-400 hover:bg-gray-500/10 transition-colors">
                                            Отмена
                                        </button>
                                        ${this.editingEvent ? `
                                            <button onclick="app.deleteCurrentEvent()" class="px-4 py-3 rounded-xl bg-red-500/20 text-red-300 hover:bg-red-500/30 border border-red-500/30 transition-colors">
                                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                                            </button>
                                        ` : ''}
                                        <button onclick="app.saveEvent()" class="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-semibold hover:from-purple-600 hover:to-pink-600 transition-all duration-300 shadow-lg hover:shadow-xl">
                                            ${this.editingEvent ? 'Сохранить' : 'Создать'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }



                return modals;
            }

            // Методы для работы с модальными окнами
            closeEventModal() {
                this.isFormActive = false; // Деактивируем форму
                this.showEventModal = false;
                this.editingEvent = null;
                this.resetForm();
                storage.set('tempEventForm', null); // Очищаем временную форму
                this.render();
            }



            startEditEvent(eventId) {
                const event = this.events.find(e => e.id == eventId);
                if (event) {
                    this.editingEvent = event;
                    this.eventForm = {
                        title: event.title,
                        date: event.dateTime.split('T')[0],
                        time: event.dateTime.split('T')[1],
                        description: event.description || '',
                        color: event.color || '#8B5CF6',
                        notifications: event.notifications || []
                    };
                    // Сохраняем форму для восстановления
                    storage.set('tempEventForm', this.eventForm);
                    this.showEventModal = true;
                    this.isFormActive = true; // Активируем форму
                    this.render();
                }
            }

            openNewEventModal() {
                this.showEventModal = true;
                this.isFormActive = true; // Активируем форму
                this.render();
            }

            updateEventForm(field, value) {
                this.eventForm[field] = value;
                // Сохраняем в localStorage для надежности
                const tempForm = { ...this.eventForm };
                storage.set('tempEventForm', tempForm);
            }

            saveEvent() {
                // Восстанавливаем форму из localStorage если потеряли данные
                const tempForm = storage.get('tempEventForm');
                if (tempForm) {
                    this.eventForm = { ...this.eventForm, ...tempForm };
                }

                // Дополнительно получаем значения из полей формы
                const titleEl = document.getElementById('eventTitle');
                const dateEl = document.getElementById('eventDate');
                const timeEl = document.getElementById('eventTime');
                const descEl = document.getElementById('eventDescription');
                
                if (titleEl) this.eventForm.title = titleEl.value;
                if (dateEl) this.eventForm.date = dateEl.value;
                if (timeEl) this.eventForm.time = timeEl.value;
                if (descEl) this.eventForm.description = descEl.value;

                // Очищаем временную форму
                storage.set('tempEventForm', null);

                if (this.editingEvent) {
                    this.editEvent();
                } else {
                    this.addEvent();
                }
            }

            deleteCurrentEvent() {
                if (this.editingEvent && confirm('Вы уверены, что хотите удалить это событие?')) {
                    this.deleteEvent(this.editingEvent.id);
                    this.closeEventModal();
                }
            }

            testNotification() {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('Event Timer - Тест 🔔', {
                        body: 'Это тестовое уведомление! Уведомления работают корректно.',
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDNi40NzcgMiAyIDYuNDc3IDIgMTJzNC40NzcgMTAgMTAgMTAgMTAtNC40NzcgMTAtMTBTMTcuNTIzIDIgMTIgMnoiIGZpbGw9IiM4QjVDRjYiLz4KPHBhdGggZD0iTTkgMTJsMS41IDEuNUwxNSA5IiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIGZpbGw9Im5vbmUiLz4KPC9zdmc+',
                        tag: 'event-timer-test-manual',
                        requireInteraction: false
                    });
                } else if (Notification.permission === 'default') {
                    this.requestNotificationPermission();
                } else {
                    alert('Уведомления заблокированы в настройках браузера. Разблокируйте их вручную.');
                }
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    this.handlePhotoUpload(file);
                }
                event.target.value = ''; // Сброс input для возможности загрузки того же файла повторно
            }

            // Добавляем недостающий обработчик
            handleFileUpload(event) {
                const file = event.target.files[0];
                if (file && file.type.startsWith('image/')) {
                    this.handlePhotoUpload(file);
                }
                event.target.value = '';
            }
        }

        // Создаем глобальный экземпляр приложения
        window.app = new EventTimerApp();

        // Добавляем обработчик для предотвращения потери фокуса
        document.addEventListener('focusout', (e) => {
            // Если фокус уходит с поля ввода в модальном окне
            if (e.target && e.target.closest && e.target.closest('.modal-form')) {
                setTimeout(() => {
                    // Восстанавливаем значения полей из localStorage если они потерялись
                    const tempForm = storage.get('tempEventForm');
                    if (tempForm) {
                        const titleEl = document.getElementById('eventTitle');
                        const dateEl = document.getElementById('eventDate');
                        const timeEl = document.getElementById('eventTime');
                        const descEl = document.getElementById('eventDescription');
                        
                        if (titleEl && !titleEl.value && tempForm.title) titleEl.value = tempForm.title;
                        if (dateEl && !dateEl.value && tempForm.date) dateEl.value = tempForm.date;
                        if (timeEl && !timeEl.value && tempForm.time) timeEl.value = tempForm.time;
                        if (descEl && !descEl.value && tempForm.description) descEl.value = tempForm.description;
                    }
                }, 100);
            }
        });
    </script>
</body>
</html>
